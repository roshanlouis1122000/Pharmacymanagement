import { __awaiter, __decorate, __metadata } from "tslib";
import { Component, ElementRef, Input, Output, EventEmitter } from '@angular/core';
import { GoogleChartsLoaderService } from '../google-charts-loader.service';
import { GoogleChartsDataTable } from '../google-charts-datatable';
import { ChartHTMLTooltip } from './chart-html-tooltip';
export var GoogleChartType;
(function (GoogleChartType) {
    GoogleChartType["AnnotationChart"] = "AnnotationChart";
    GoogleChartType["AreaChart"] = "AreaChart";
    GoogleChartType["BarChart"] = "BarChart";
    GoogleChartType["BubbleChart"] = "BubbleChart";
    GoogleChartType["Calendar"] = "Calendar";
    GoogleChartType["CandlestickChart"] = "CandlestickChart";
    GoogleChartType["ColumnChart"] = "ColumnChart";
    GoogleChartType["ComboChart"] = "ComboChart";
    GoogleChartType["Gantt"] = "Gantt";
    GoogleChartType["Gauge"] = "Gauge";
    GoogleChartType["GeoChart"] = "GeoChart";
    GoogleChartType["Histogram"] = "Histogram";
    GoogleChartType["LineChart"] = "LineChart";
    GoogleChartType["Map"] = "Map";
    GoogleChartType["OrgChart"] = "OrgChart";
    GoogleChartType["PieChart"] = "PieChart";
    GoogleChartType["Sankey"] = "Sankey";
    GoogleChartType["ScatterChart"] = "ScatterChart";
    GoogleChartType["SteppedAreaChart"] = "SteppedAreaChart";
    GoogleChartType["Table"] = "Table";
    GoogleChartType["Timeline"] = "Timeline";
    GoogleChartType["TreeMap"] = "TreeMap";
    GoogleChartType["WordTree"] = "WordTree";
})(GoogleChartType || (GoogleChartType = {}));
let GoogleChartComponent = class GoogleChartComponent {
    constructor(el, loaderService) {
        this.el = el;
        this.loaderService = loaderService;
        this.selectListener = () => {
            const event = {
                message: 'select',
                row: null,
                column: null,
                selectedRowValues: [],
                selectedRowFormattedValues: [],
                columnLabel: ''
            };
            const s = this.wrapper.visualization.getSelection();
            const gs = s[s.length - 1];
            if (!gs) {
                event.message = 'deselect';
                return event;
            }
            const selection = gs;
            if (gs.row != null) {
                event.row = selection.row;
                const selectedRowValues = [];
                const selectedRowFormattedValues = [];
                const dataTable = this.wrapper.getDataTable();
                const numberOfColumns = dataTable.getNumberOfColumns();
                for (let i = 0; i < numberOfColumns; i++) {
                    selectedRowValues.push(dataTable.getValue(selection.row, i));
                    selectedRowFormattedValues.push(dataTable.getFormattedValue(selection.row, i));
                }
                event.selectedRowValues = selectedRowValues;
                event.selectedRowFormattedValues = selectedRowFormattedValues;
            }
            if (selection.column != null) {
                event.column = selection.column;
                event.columnLabel = this.getColumnLabelAtPosition(selection);
            }
            if (gs.name) {
                event.columnLabel = gs.name;
            }
            return event;
        };
        this.chartSelect = new EventEmitter();
        this.chartSelectOneTime = new EventEmitter();
        this.chartReady = new EventEmitter();
        this.chartReadyOneTime = new EventEmitter();
        this.chartError = new EventEmitter();
        this.chartErrorOneTime = new EventEmitter();
        this.mouseOver = new EventEmitter();
        this.mouseOverOneTime = new EventEmitter();
        this.mouseOut = new EventEmitter();
        this.mouseOutOneTime = new EventEmitter();
        this.regionClick = new EventEmitter();
        this.regionClickOneTime = new EventEmitter();
    }
    ngOnInit() {
        this.HTMLel = this.el.nativeElement.querySelector('div');
        if (Object.isExtensible(this.data)) {
            this.data.component = this;
        }
        this.options = this.data.options;
        this.init().then(() => {
            this.draw();
        });
    }
    init() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loaderService.load();
            this.recreateWrapper();
        });
    }
    recreateWrapper() {
        if (this.wrapper === undefined || this.wrapper.getChartType() !== this.data.chartType) {
            this.dataTable = new GoogleChartsDataTable(this.data);
            this.dataTable.dataTableChanged.subscribe((dt) => {
                this._draw();
            });
            // see dataTable in https://developers.google.com/chart/interactive/docs/reference#google.visualization.drawchart
            let temp = this.data;
            if (this.data.firstRowIsData) {
                temp = Object.assign(temp, this.data);
                temp.dataTable = this.dataTable.getDataTable();
            }
            this.wrapper = new google.visualization.ChartWrapper(temp);
            this.registerChartWrapperEvents();
            /* Calling draw even without data is the only way to pass the HTMl element
               when using the chart in a dashboard. Don't do this in all other cases:
               it breaks formatters with remote data source, hence the conditional. */
            if (temp.dataTable === undefined && temp.dataSourceUrl === undefined) {
                try {
                    this.wrapper.draw(this.HTMLel);
                }
                catch (err) { }
            }
        }
    }
    _draw() {
        return __awaiter(this, void 0, void 0, function* () {
            const dt = this.dataTable.getDataTable();
            if (dt === undefined) {
                return;
            }
            this.convertOptions();
            this.recreateWrapper();
            this.wrapper.setOptions(this.options);
            this.wrapper.setDataTable(dt);
            this.wrapper.draw(this.HTMLel);
        });
    }
    getDataTable() {
        return this.dataTable;
    }
    draw(value) {
        if (value === undefined) {
            value = this.data;
        }
        this.options = value.options;
        this.dataTable.init(value);
    }
    getSelectorBySeriesType(seriesType) {
        const selectors = {
            bars: 'bar#%s#%r',
            haxis: 'hAxis#0#label',
            line: 'point#%s#%r',
            legend: 'legendentry#%s',
            area: 'point#%s#%r'
        };
        const selector = selectors[seriesType];
        return selector;
    }
    /**
     * Given a column number, counts how many
     * columns have rol=="data". Those are mapped
     * one-to-one to the series array. When rol is not defined
     * a column of type number means a series column.
     * @param column to inspect
     */
    getSeriesByColumn(column) {
        let series = 0;
        const dataTable = this.wrapper.getDataTable();
        for (let i = column - 1; i >= 0; i--) {
            const role = dataTable.getColumnRole(i);
            const type = dataTable.getColumnType(i);
            if (role === 'data' || type === 'number') {
                series++;
            }
        }
        return series;
    }
    getBoundingBoxForItem(item) {
        let boundingBox = { top: 0, left: 0, width: 0, height: 0 };
        if (this.cli) {
            const column = item.column;
            const series = this.getSeriesByColumn(column);
            const row = item.row;
            let seriesType = this.options.seriesType;
            if (this.options.series && this.options.series[series] && this.options.series[series].type) {
                seriesType = this.options.series[series].type;
            }
            if (seriesType) {
                let selector = this.getSelectorBySeriesType(seriesType);
                if (selector) {
                    selector = selector.replace('%s', series + '').replace('%c', column + '').replace('%r', row + '');
                    const box = this.cli.getBoundingBox(selector);
                    if (box) {
                        boundingBox = box;
                    }
                }
            }
        }
        return boundingBox;
    }
    getValueAtPosition(position) {
        if (position.row == null) {
            return null;
        }
        const dataTable = this.wrapper.getDataTable();
        const value = dataTable.getValue(position.row, position.column);
        return value;
    }
    getColumnTypeAtPosition(position) {
        const dataTable = this.wrapper.getDataTable();
        const type = dataTable.getColumnType(position.column) || '';
        return type;
    }
    getColumnLabelAtPosition(position) {
        const dataTable = this.wrapper.getDataTable();
        const type = dataTable.getColumnLabel(position.column) || '';
        return type;
    }
    getHTMLTooltip() {
        const tooltipER = new ElementRef(this.el.nativeElement.querySelector('.google-visualization-tooltip'));
        return new ChartHTMLTooltip(tooltipER);
    }
    parseMouseEvent(item) {
        const chartType = this.wrapper.getChartType();
        let eventColumn = item.column;
        if (eventColumn == null) {
            switch (chartType) {
                case 'Timeline':
                    eventColumn = this.wrapper.getDataTable().getNumberOfColumns() === 3 ? 0 : 1;
                    break;
                default:
                    eventColumn = 0;
            }
        }
        const eventRow = item.row;
        const myItem = {
            row: eventRow,
            column: eventColumn
        };
        const event = {
            position: item,
            boundingBox: this.getBoundingBoxForItem(myItem),
            value: this.getValueAtPosition(myItem),
            columnType: this.getColumnTypeAtPosition(myItem),
            columnLabel: this.getColumnLabelAtPosition(myItem)
        };
        return event;
    }
    registerChartEvents() {
        const chart = this.wrapper.getChart();
        this.cli = chart.getChartLayoutInterface ? chart.getChartLayoutInterface() : null;
        if (this.mouseOver.observers.length > 0) {
            google.visualization.events.addListener(chart, 'onmouseover', (item) => {
                const event = this.parseMouseEvent(item);
                event.tooltip = this.getHTMLTooltip();
                this.mouseOver.emit(event);
            });
        }
        if (this.mouseOverOneTime.observers.length > 0) {
            google.visualization.events.addOneTimeListener(chart, 'onmouseover', (item) => {
                const event = this.parseMouseEvent(item);
                event.tooltip = this.getHTMLTooltip();
                this.mouseOverOneTime.emit(event);
            });
        }
        if (this.mouseOut.observers.length > 0) {
            google.visualization.events.addListener(chart, 'onmouseout', (item) => {
                const event = this.parseMouseEvent(item);
                this.mouseOut.emit(event);
            });
        }
        if (this.mouseOutOneTime.observers.length > 0) {
            google.visualization.events.addOneTimeListener(chart, 'onmouseout', (item) => {
                const event = this.parseMouseEvent(item);
                this.mouseOutOneTime.emit(event);
            });
        }
        if (this.data.chartType === 'GeoChart') {
            if (this.regionClick.observers.length > 0) {
                google.visualization.events.addListener(chart, 'regionClick', (item) => {
                    this.regionClick.emit(item);
                });
            }
            if (this.regionClickOneTime.observers.length > 0) {
                google.visualization.events.addOneTimeListener(chart, 'regionClick', (item) => {
                    this.regionClick.emit(item);
                });
            }
        }
    }
    registerChartWrapperEvents() {
        google.visualization.events.addListener(this.wrapper, 'ready', () => {
            this.chartReady.emit({ message: 'Chart ready' });
        });
        google.visualization.events.addOneTimeListener(this.wrapper, 'ready', () => {
            this.chartReadyOneTime.emit({ message: 'Chart ready (one time)' });
            this.registerChartEvents();
        });
        google.visualization.events.addListener(this.wrapper, 'error', (error) => {
            this.chartError.emit(error);
        });
        google.visualization.events.addOneTimeListener(this.wrapper, 'error', (error) => {
            this.chartErrorOneTime.emit(error);
        });
        this.addListener(this.wrapper, 'select', this.selectListener, this.chartSelect);
        this.addOneTimeListener(this.wrapper, 'select', this.selectListener, this.chartSelectOneTime);
    }
    addListener(source, eventType, listenerFn, evEmitter) {
        google.visualization.events.addListener(source, eventType, () => {
            evEmitter.emit(listenerFn());
        });
    }
    addOneTimeListener(source, eventType, listenerFn, evEmitter) {
        google.visualization.events.addOneTimeListener(source, eventType, () => {
            evEmitter.emit(listenerFn());
        });
    }
    convertOptions() {
        try {
            this.options = google.charts[this.data.chartType].convertOptions(this.options);
        }
        catch (error) {
            return;
        }
    }
};
__decorate([
    Input(),
    __metadata("design:type", Object)
], GoogleChartComponent.prototype, "data", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "chartReady", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "chartReadyOneTime", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "chartError", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "chartErrorOneTime", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "chartSelect", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "chartSelectOneTime", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "mouseOver", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "mouseOverOneTime", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "mouseOut", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "mouseOutOneTime", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "regionClick", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], GoogleChartComponent.prototype, "regionClickOneTime", void 0);
GoogleChartComponent = __decorate([
    Component({
        selector: 'google-chart',
        template: '<div></div>'
    }),
    __metadata("design:paramtypes", [ElementRef,
        GoogleChartsLoaderService])
], GoogleChartComponent);
export { GoogleChartComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWNoYXJ0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nMi1nb29nbGUtY2hhcnRzL3NyYy9saWIvZ29vZ2xlLWNoYXJ0L2dvb2dsZS1jaGFydC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUVWLEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNiLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQzVFLE9BQU8sRUFBRSxxQkFBcUIsRUFBa0MsTUFBTSw0QkFBNEIsQ0FBQztBQVduRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQVV4RCxNQUFNLENBQU4sSUFBWSxlQXdCWDtBQXhCRCxXQUFZLGVBQWU7SUFDekIsc0RBQW1DLENBQUE7SUFDbkMsMENBQXVCLENBQUE7SUFDdkIsd0NBQXFCLENBQUE7SUFDckIsOENBQTJCLENBQUE7SUFDM0Isd0NBQXFCLENBQUE7SUFDckIsd0RBQXFDLENBQUE7SUFDckMsOENBQTJCLENBQUE7SUFDM0IsNENBQXlCLENBQUE7SUFDekIsa0NBQWUsQ0FBQTtJQUNmLGtDQUFlLENBQUE7SUFDZix3Q0FBcUIsQ0FBQTtJQUNyQiwwQ0FBdUIsQ0FBQTtJQUN2QiwwQ0FBdUIsQ0FBQTtJQUN2Qiw4QkFBVyxDQUFBO0lBQ1gsd0NBQXFCLENBQUE7SUFDckIsd0NBQXFCLENBQUE7SUFDckIsb0NBQWlCLENBQUE7SUFDakIsZ0RBQTZCLENBQUE7SUFDN0Isd0RBQXFDLENBQUE7SUFDckMsa0NBQWUsQ0FBQTtJQUNmLHdDQUFxQixDQUFBO0lBQ3JCLHNDQUFtQixDQUFBO0lBQ25CLHdDQUFxQixDQUFBO0FBQ3ZCLENBQUMsRUF4QlcsZUFBZSxLQUFmLGVBQWUsUUF3QjFCO0FBTUQs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QjtBQUV4RDtJQUFULE1BQU0sRUFBRTs4QkFBb0IsWUFBWTt3REFBa0I7QUFDakQ7SUFBVCxNQUFNLEVBQUU7OEJBQTJCLFlBQVk7K0RBQWtCO0FBRXhEO0lBQVQsTUFBTSxFQUFFOzhCQUFxQixZQUFZO3lEQUFtQjtBQUNuRDtJQUFULE1BQU0sRUFBRTs4QkFBNEIsWUFBWTtnRUFBbUI7QUFFMUQ7SUFBVCxNQUFNLEVBQUU7OEJBQW1CLFlBQVk7dURBQXNCO0FBQ3BEO0lBQVQsTUFBTSxFQUFFOzhCQUEwQixZQUFZOzhEQUFzQjtBQUUzRDtJQUFULE1BQU0sRUFBRTs4QkFBa0IsWUFBWTtzREFBcUI7QUFDbEQ7SUFBVCxNQUFNLEVBQUU7OEJBQXlCLFlBQVk7NkRBQXFCO0FBRXpEO0lBQVQsTUFBTSxFQUFFOzhCQUFxQixZQUFZO3lEQUFtQjtBQUNuRDtJQUFULE1BQU0sRUFBRTs4QkFBNEIsWUFBWTtnRUFBbUI7QUFwQnpELG9CQUFvQjtJQUpoQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsY0FBYztRQUN4QixRQUFRLEVBQUUsYUFBYTtLQUN4QixDQUFDO3FDQThCK0IsVUFBVTtRQUNDLHlCQUF5QjtHQTlCeEQsb0JBQW9CLENBaVdoQztTQWpXWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJkZWNsYXJlIHZhciBnb29nbGU6IGFueTtcblxuaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBPbkluaXQsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgR29vZ2xlQ2hhcnRzTG9hZGVyU2VydmljZSB9IGZyb20gJy4uL2dvb2dsZS1jaGFydHMtbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgR29vZ2xlQ2hhcnRzRGF0YVRhYmxlLCBHb29nbGVDaGFydHNEYXRhVGFibGVJbnRlcmZhY2UgfSBmcm9tICcuLi9nb29nbGUtY2hhcnRzLWRhdGF0YWJsZSc7XG5pbXBvcnQgeyBDaGFydFJlYWR5RXZlbnQgfSBmcm9tICcuL2NoYXJ0LXJlYWR5LWV2ZW50JztcbmltcG9ydCB7IENoYXJ0RXJyb3JFdmVudCB9IGZyb20gJy4vY2hhcnQtZXJyb3ItZXZlbnQnO1xuaW1wb3J0IHsgQ2hhcnRTZWxlY3RFdmVudCB9IGZyb20gJy4vY2hhcnQtc2VsZWN0LWV2ZW50JztcbmltcG9ydCB7XG4gIENoYXJ0TW91c2VFdmVudCxcbiAgQ2hhcnRNb3VzZU92ZXJFdmVudCxcbiAgQ2hhcnRNb3VzZU91dEV2ZW50LFxuICBCb3VuZGluZ0JveCxcbiAgRGF0YVBvaW50UG9zaXRpb25cbn0gZnJvbSAnLi9jaGFydC1tb3VzZS1ldmVudCc7XG5pbXBvcnQgeyBDaGFydEhUTUxUb29sdGlwIH0gZnJvbSAnLi9jaGFydC1odG1sLXRvb2x0aXAnO1xuaW1wb3J0IHsgUmVnaW9uQ2xpY2tFdmVudCB9IGZyb20gJy4vZ2VvY2hhcnQtZXZlbnRzJztcblxuZXhwb3J0IGludGVyZmFjZSBHb29nbGVDaGFydEludGVyZmFjZSBleHRlbmRzIEdvb2dsZUNoYXJ0c0RhdGFUYWJsZUludGVyZmFjZSB7XG4gIGNoYXJ0VHlwZTogc3RyaW5nIHwgR29vZ2xlQ2hhcnRUeXBlO1xuICBvcHRpb25zPzogYW55O1xuXG4gIGNvbXBvbmVudD86IEdvb2dsZUNoYXJ0Q29tcG9uZW50O1xufVxuXG5leHBvcnQgZW51bSBHb29nbGVDaGFydFR5cGUge1xuICBBbm5vdGF0aW9uQ2hhcnQgPSAnQW5ub3RhdGlvbkNoYXJ0JyxcbiAgQXJlYUNoYXJ0ID0gJ0FyZWFDaGFydCcsXG4gIEJhckNoYXJ0ID0gJ0JhckNoYXJ0JyxcbiAgQnViYmxlQ2hhcnQgPSAnQnViYmxlQ2hhcnQnLFxuICBDYWxlbmRhciA9ICdDYWxlbmRhcicsXG4gIENhbmRsZXN0aWNrQ2hhcnQgPSAnQ2FuZGxlc3RpY2tDaGFydCcsXG4gIENvbHVtbkNoYXJ0ID0gJ0NvbHVtbkNoYXJ0JyxcbiAgQ29tYm9DaGFydCA9ICdDb21ib0NoYXJ0JyxcbiAgR2FudHQgPSAnR2FudHQnLFxuICBHYXVnZSA9ICdHYXVnZScsXG4gIEdlb0NoYXJ0ID0gJ0dlb0NoYXJ0JyxcbiAgSGlzdG9ncmFtID0gJ0hpc3RvZ3JhbScsXG4gIExpbmVDaGFydCA9ICdMaW5lQ2hhcnQnLFxuICBNYXAgPSAnTWFwJyxcbiAgT3JnQ2hhcnQgPSAnT3JnQ2hhcnQnLFxuICBQaWVDaGFydCA9ICdQaWVDaGFydCcsXG4gIFNhbmtleSA9ICdTYW5rZXknLFxuICBTY2F0dGVyQ2hhcnQgPSAnU2NhdHRlckNoYXJ0JyxcbiAgU3RlcHBlZEFyZWFDaGFydCA9ICdTdGVwcGVkQXJlYUNoYXJ0JyxcbiAgVGFibGUgPSAnVGFibGUnLFxuICBUaW1lbGluZSA9ICdUaW1lbGluZScsXG4gIFRyZWVNYXAgPSAnVHJlZU1hcCcsXG4gIFdvcmRUcmVlID0gJ1dvcmRUcmVlJ1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdnb29nbGUtY2hhcnQnLFxuICB0ZW1wbGF0ZTogJzxkaXY+PC9kaXY+Jyxcbn0pXG5leHBvcnQgY2xhc3MgR29vZ2xlQ2hhcnRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gIEBJbnB1dCgpIHB1YmxpYyBkYXRhOiBHb29nbGVDaGFydEludGVyZmFjZTtcblxuICBAT3V0cHV0KCkgcHVibGljIGNoYXJ0UmVhZHk6IEV2ZW50RW1pdHRlcjxDaGFydFJlYWR5RXZlbnQ+O1xuICBAT3V0cHV0KCkgcHVibGljIGNoYXJ0UmVhZHlPbmVUaW1lOiBFdmVudEVtaXR0ZXI8Q2hhcnRSZWFkeUV2ZW50PjtcblxuICBAT3V0cHV0KCkgcHVibGljIGNoYXJ0RXJyb3I6IEV2ZW50RW1pdHRlcjxDaGFydEVycm9yRXZlbnQ+O1xuICBAT3V0cHV0KCkgcHVibGljIGNoYXJ0RXJyb3JPbmVUaW1lOiBFdmVudEVtaXR0ZXI8Q2hhcnRFcnJvckV2ZW50PjtcblxuICBAT3V0cHV0KCkgcHVibGljIGNoYXJ0U2VsZWN0OiBFdmVudEVtaXR0ZXI8Q2hhcnRTZWxlY3RFdmVudD47XG4gIEBPdXRwdXQoKSBwdWJsaWMgY2hhcnRTZWxlY3RPbmVUaW1lOiBFdmVudEVtaXR0ZXI8Q2hhcnRTZWxlY3RFdmVudD47XG5cbiAgQE91dHB1dCgpIHB1YmxpYyBtb3VzZU92ZXI6IEV2ZW50RW1pdHRlcjxDaGFydE1vdXNlT3ZlckV2ZW50PjtcbiAgQE91dHB1dCgpIHB1YmxpYyBtb3VzZU92ZXJPbmVUaW1lOiBFdmVudEVtaXR0ZXI8Q2hhcnRNb3VzZU92ZXJFdmVudD47XG5cbiAgQE91dHB1dCgpIHB1YmxpYyBtb3VzZU91dDogRXZlbnRFbWl0dGVyPENoYXJ0TW91c2VPdXRFdmVudD47XG4gIEBPdXRwdXQoKSBwdWJsaWMgbW91c2VPdXRPbmVUaW1lOiBFdmVudEVtaXR0ZXI8Q2hhcnRNb3VzZU91dEV2ZW50PjtcblxuICBAT3V0cHV0KCkgcHVibGljIHJlZ2lvbkNsaWNrOiBFdmVudEVtaXR0ZXI8UmVnaW9uQ2xpY2tFdmVudD47XG4gIEBPdXRwdXQoKSBwdWJsaWMgcmVnaW9uQ2xpY2tPbmVUaW1lOiBFdmVudEVtaXR0ZXI8UmVnaW9uQ2xpY2tFdmVudD47XG5cbiAgcHVibGljIHdyYXBwZXI6IGFueTtcbiAgcHJpdmF0ZSBjbGk6IGFueTtcbiAgcHJpdmF0ZSBvcHRpb25zOiBhbnk7XG5cbiAgcHJpdmF0ZSBIVE1MZWw6IEhUTUxFbGVtZW50O1xuICBwcml2YXRlIGRhdGFUYWJsZTogR29vZ2xlQ2hhcnRzRGF0YVRhYmxlO1xuXG4gIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxuICAgICAgICAgICAgICAgICAgICAgcHJpdmF0ZSBsb2FkZXJTZXJ2aWNlOiBHb29nbGVDaGFydHNMb2FkZXJTZXJ2aWNlKSB7XG4gICAgdGhpcy5jaGFydFNlbGVjdCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLmNoYXJ0U2VsZWN0T25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLmNoYXJ0UmVhZHkgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5jaGFydFJlYWR5T25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLmNoYXJ0RXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5jaGFydEVycm9yT25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLm1vdXNlT3ZlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLm1vdXNlT3Zlck9uZVRpbWUgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgdGhpcy5tb3VzZU91dCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLm1vdXNlT3V0T25lVGltZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLnJlZ2lvbkNsaWNrID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIHRoaXMucmVnaW9uQ2xpY2tPbmVUaW1lID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICB9XG5cbiAgcHVibGljIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuSFRNTGVsID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2RpdicpO1xuICAgIGlmIChPYmplY3QuaXNFeHRlbnNpYmxlKHRoaXMuZGF0YSkpIHtcbiAgICAgIHRoaXMuZGF0YS5jb21wb25lbnQgPSB0aGlzO1xuICAgIH1cbiAgICB0aGlzLm9wdGlvbnMgPSB0aGlzLmRhdGEub3B0aW9ucztcblxuICAgIHRoaXMuaW5pdCgpLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5kcmF3KCk7XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdCgpIHtcbiAgICBhd2FpdCB0aGlzLmxvYWRlclNlcnZpY2UubG9hZCgpO1xuICAgIHRoaXMucmVjcmVhdGVXcmFwcGVyKCk7XG4gIH1cblxuICBwcml2YXRlIHJlY3JlYXRlV3JhcHBlcigpIHtcbiAgICBpZiAodGhpcy53cmFwcGVyID09PSB1bmRlZmluZWQgfHwgdGhpcy53cmFwcGVyLmdldENoYXJ0VHlwZSgpICE9PSB0aGlzLmRhdGEuY2hhcnRUeXBlKSB7XG4gICAgICB0aGlzLmRhdGFUYWJsZSA9IG5ldyBHb29nbGVDaGFydHNEYXRhVGFibGUodGhpcy5kYXRhKTtcbiAgICAgIHRoaXMuZGF0YVRhYmxlLmRhdGFUYWJsZUNoYW5nZWQuc3Vic2NyaWJlKChkdDogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuX2RyYXcoKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBzZWUgZGF0YVRhYmxlIGluIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL2NoYXJ0L2ludGVyYWN0aXZlL2RvY3MvcmVmZXJlbmNlI2dvb2dsZS52aXN1YWxpemF0aW9uLmRyYXdjaGFydFxuICAgICAgbGV0IHRlbXA6IEdvb2dsZUNoYXJ0SW50ZXJmYWNlID0gdGhpcy5kYXRhO1xuICAgICAgaWYgKHRoaXMuZGF0YS5maXJzdFJvd0lzRGF0YSkge1xuICAgICAgICB0ZW1wID0gT2JqZWN0LmFzc2lnbih0ZW1wLCB0aGlzLmRhdGEpO1xuICAgICAgICB0ZW1wLmRhdGFUYWJsZSA9IHRoaXMuZGF0YVRhYmxlLmdldERhdGFUYWJsZSgpO1xuICAgICAgfVxuICAgICAgdGhpcy53cmFwcGVyID0gbmV3IGdvb2dsZS52aXN1YWxpemF0aW9uLkNoYXJ0V3JhcHBlcih0ZW1wKTtcbiAgICAgIHRoaXMucmVnaXN0ZXJDaGFydFdyYXBwZXJFdmVudHMoKTtcblxuICAgICAgLyogQ2FsbGluZyBkcmF3IGV2ZW4gd2l0aG91dCBkYXRhIGlzIHRoZSBvbmx5IHdheSB0byBwYXNzIHRoZSBIVE1sIGVsZW1lbnRcbiAgICAgICAgIHdoZW4gdXNpbmcgdGhlIGNoYXJ0IGluIGEgZGFzaGJvYXJkLiBEb24ndCBkbyB0aGlzIGluIGFsbCBvdGhlciBjYXNlczpcbiAgICAgICAgIGl0IGJyZWFrcyBmb3JtYXR0ZXJzIHdpdGggcmVtb3RlIGRhdGEgc291cmNlLCBoZW5jZSB0aGUgY29uZGl0aW9uYWwuICovXG4gICAgICBpZiAodGVtcC5kYXRhVGFibGUgPT09IHVuZGVmaW5lZCAmJiB0ZW1wLmRhdGFTb3VyY2VVcmwgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMud3JhcHBlci5kcmF3KHRoaXMuSFRNTGVsKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgX2RyYXcoKSB7XG4gICAgY29uc3QgZHQgPSB0aGlzLmRhdGFUYWJsZS5nZXREYXRhVGFibGUoKTtcbiAgICBpZiAoZHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmNvbnZlcnRPcHRpb25zKCk7XG4gICAgdGhpcy5yZWNyZWF0ZVdyYXBwZXIoKTtcbiAgICB0aGlzLndyYXBwZXIuc2V0T3B0aW9ucyh0aGlzLm9wdGlvbnMpO1xuICAgIHRoaXMud3JhcHBlci5zZXREYXRhVGFibGUoZHQpO1xuICAgIHRoaXMud3JhcHBlci5kcmF3KHRoaXMuSFRNTGVsKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXREYXRhVGFibGUoKTogR29vZ2xlQ2hhcnRzRGF0YVRhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhVGFibGU7XG4gIH1cblxuICBwdWJsaWMgZHJhdyh2YWx1ZT86IEdvb2dsZUNoYXJ0SW50ZXJmYWNlKSB7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHZhbHVlID0gdGhpcy5kYXRhO1xuICAgIH1cbiAgICB0aGlzLm9wdGlvbnMgPSB2YWx1ZS5vcHRpb25zO1xuICAgIHRoaXMuZGF0YVRhYmxlLmluaXQodmFsdWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTZWxlY3RvckJ5U2VyaWVzVHlwZShzZXJpZXNUeXBlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHNlbGVjdG9yczogYW55ID0ge1xuICAgICAgYmFycyA6ICdiYXIjJXMjJXInLFxuICAgICAgaGF4aXMgOiAnaEF4aXMjMCNsYWJlbCcsXG4gICAgICBsaW5lOiAncG9pbnQjJXMjJXInLFxuICAgICAgbGVnZW5kIDogJ2xlZ2VuZGVudHJ5IyVzJyxcbiAgICAgIGFyZWE6ICdwb2ludCMlcyMlcidcbiAgICB9O1xuXG4gICAgY29uc3Qgc2VsZWN0b3I6IHN0cmluZyA9IHNlbGVjdG9yc1tzZXJpZXNUeXBlXTtcblxuICAgIHJldHVybiBzZWxlY3RvcjtcbiAgfVxuXG4gLyoqXG4gICogR2l2ZW4gYSBjb2x1bW4gbnVtYmVyLCBjb3VudHMgaG93IG1hbnlcbiAgKiBjb2x1bW5zIGhhdmUgcm9sPT1cImRhdGFcIi4gVGhvc2UgYXJlIG1hcHBlZFxuICAqIG9uZS10by1vbmUgdG8gdGhlIHNlcmllcyBhcnJheS4gV2hlbiByb2wgaXMgbm90IGRlZmluZWRcbiAgKiBhIGNvbHVtbiBvZiB0eXBlIG51bWJlciBtZWFucyBhIHNlcmllcyBjb2x1bW4uXG4gICogQHBhcmFtIGNvbHVtbiB0byBpbnNwZWN0XG4gICovXG4gIHByaXZhdGUgZ2V0U2VyaWVzQnlDb2x1bW4oY29sdW1uOiBudW1iZXIpOiBudW1iZXIgIHtcbiAgICBsZXQgc2VyaWVzID0gMDtcbiAgICBjb25zdCBkYXRhVGFibGUgPSB0aGlzLndyYXBwZXIuZ2V0RGF0YVRhYmxlKCk7XG4gICAgZm9yIChsZXQgaSA9IGNvbHVtbiAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBjb25zdCByb2xlID0gZGF0YVRhYmxlLmdldENvbHVtblJvbGUoaSk7XG4gICAgICBjb25zdCB0eXBlID0gZGF0YVRhYmxlLmdldENvbHVtblR5cGUoaSk7XG4gICAgICBpZiAocm9sZSA9PT0gJ2RhdGEnIHx8IHR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIHNlcmllcysrO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2VyaWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRCb3VuZGluZ0JveEZvckl0ZW0oaXRlbTogRGF0YVBvaW50UG9zaXRpb24pOiBCb3VuZGluZ0JveCB7XG4gICAgbGV0IGJvdW5kaW5nQm94ID0ge3RvcDogMCwgbGVmdDogMCwgd2lkdGg6IDAsIGhlaWdodDogMH07XG4gICAgaWYgKHRoaXMuY2xpKSB7XG4gICAgICBjb25zdCBjb2x1bW4gPSBpdGVtLmNvbHVtbjtcbiAgICAgIGNvbnN0IHNlcmllcyA9IHRoaXMuZ2V0U2VyaWVzQnlDb2x1bW4oY29sdW1uKTtcbiAgICAgIGNvbnN0IHJvdyA9IGl0ZW0ucm93O1xuICAgICAgbGV0IHNlcmllc1R5cGUgPSB0aGlzLm9wdGlvbnMuc2VyaWVzVHlwZTtcbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2VyaWVzICYmIHRoaXMub3B0aW9ucy5zZXJpZXNbc2VyaWVzXSAmJiB0aGlzLm9wdGlvbnMuc2VyaWVzW3Nlcmllc10udHlwZSkge1xuICAgICAgICBzZXJpZXNUeXBlID0gdGhpcy5vcHRpb25zLnNlcmllc1tzZXJpZXNdLnR5cGU7XG4gICAgICB9XG4gICAgICBpZiAoc2VyaWVzVHlwZSkge1xuICAgICAgICBsZXQgc2VsZWN0b3IgPSB0aGlzLmdldFNlbGVjdG9yQnlTZXJpZXNUeXBlKHNlcmllc1R5cGUpO1xuICAgICAgICBpZiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoJyVzJywgc2VyaWVzICsgJycpLnJlcGxhY2UoJyVjJywgY29sdW1uICsgJycpLnJlcGxhY2UoJyVyJywgcm93ICsgJycpO1xuICAgICAgICAgICAgIGNvbnN0IGJveCA9IHRoaXMuY2xpLmdldEJvdW5kaW5nQm94KHNlbGVjdG9yKTtcbiAgICAgICAgICAgICBpZiAoYm94KSB7XG4gICAgICAgICAgICAgIGJvdW5kaW5nQm94ID0gYm94O1xuICAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBib3VuZGluZ0JveDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VmFsdWVBdFBvc2l0aW9uKHBvc2l0aW9uOiBEYXRhUG9pbnRQb3NpdGlvbik6IGFueSB7XG4gICAgaWYgKHBvc2l0aW9uLnJvdyA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZGF0YVRhYmxlID0gdGhpcy53cmFwcGVyLmdldERhdGFUYWJsZSgpO1xuICAgIGNvbnN0IHZhbHVlID0gZGF0YVRhYmxlLmdldFZhbHVlKHBvc2l0aW9uLnJvdywgcG9zaXRpb24uY29sdW1uKTtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBwcml2YXRlIGdldENvbHVtblR5cGVBdFBvc2l0aW9uKHBvc2l0aW9uOiBEYXRhUG9pbnRQb3NpdGlvbik6IHN0cmluZyB7XG4gICAgICBjb25zdCBkYXRhVGFibGUgPSB0aGlzLndyYXBwZXIuZ2V0RGF0YVRhYmxlKCk7XG4gICAgICBjb25zdCB0eXBlID0gZGF0YVRhYmxlLmdldENvbHVtblR5cGUocG9zaXRpb24uY29sdW1uKSB8fCAnJztcbiAgICAgIHJldHVybiB0eXBlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb2x1bW5MYWJlbEF0UG9zaXRpb24ocG9zaXRpb246IERhdGFQb2ludFBvc2l0aW9uKTogc3RyaW5nIHtcbiAgICAgIGNvbnN0IGRhdGFUYWJsZSA9IHRoaXMud3JhcHBlci5nZXREYXRhVGFibGUoKTtcbiAgICAgIGNvbnN0IHR5cGUgPSBkYXRhVGFibGUuZ2V0Q29sdW1uTGFiZWwocG9zaXRpb24uY29sdW1uKSB8fCAnJztcbiAgICAgIHJldHVybiB0eXBlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRIVE1MVG9vbHRpcCgpOiBDaGFydEhUTUxUb29sdGlwIHtcbiAgICBjb25zdCB0b29sdGlwRVIgPSBuZXcgRWxlbWVudFJlZih0aGlzLmVsLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmdvb2dsZS12aXN1YWxpemF0aW9uLXRvb2x0aXAnKSk7XG4gICAgcmV0dXJuIG5ldyBDaGFydEhUTUxUb29sdGlwKHRvb2x0aXBFUik7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlTW91c2VFdmVudChpdGVtOiBEYXRhUG9pbnRQb3NpdGlvbik6IENoYXJ0TW91c2VFdmVudCB7XG4gICAgY29uc3QgY2hhcnRUeXBlID0gdGhpcy53cmFwcGVyLmdldENoYXJ0VHlwZSgpO1xuICAgIGxldCBldmVudENvbHVtbiA9IGl0ZW0uY29sdW1uO1xuICAgIGlmIChldmVudENvbHVtbiA9PSBudWxsKSB7XG4gICAgICBzd2l0Y2ggKGNoYXJ0VHlwZSkge1xuICAgICAgICBjYXNlICdUaW1lbGluZSc6XG4gICAgICAgICAgZXZlbnRDb2x1bW4gPSB0aGlzLndyYXBwZXIuZ2V0RGF0YVRhYmxlKCkuZ2V0TnVtYmVyT2ZDb2x1bW5zKCkgPT09IDMgPyAwIDogMTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBldmVudENvbHVtbiA9IDA7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGV2ZW50Um93ID0gaXRlbS5yb3c7XG4gICAgY29uc3QgbXlJdGVtID0ge1xuICAgICAgcm93OiBldmVudFJvdyxcbiAgICAgIGNvbHVtbjogZXZlbnRDb2x1bW5cbiAgICB9O1xuICAgIGNvbnN0IGV2ZW50ID0ge1xuICAgICAgcG9zaXRpb246IGl0ZW0sXG4gICAgICBib3VuZGluZ0JveDogdGhpcy5nZXRCb3VuZGluZ0JveEZvckl0ZW0obXlJdGVtKSxcbiAgICAgIHZhbHVlOiB0aGlzLmdldFZhbHVlQXRQb3NpdGlvbihteUl0ZW0pLFxuICAgICAgY29sdW1uVHlwZTogdGhpcy5nZXRDb2x1bW5UeXBlQXRQb3NpdGlvbihteUl0ZW0pLFxuICAgICAgY29sdW1uTGFiZWw6IHRoaXMuZ2V0Q29sdW1uTGFiZWxBdFBvc2l0aW9uKG15SXRlbSlcbiAgICB9O1xuICAgIHJldHVybiBldmVudDtcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJDaGFydEV2ZW50cygpOiB2b2lkIHtcbiAgICBjb25zdCBjaGFydCA9IHRoaXMud3JhcHBlci5nZXRDaGFydCgpO1xuICAgIHRoaXMuY2xpID0gY2hhcnQuZ2V0Q2hhcnRMYXlvdXRJbnRlcmZhY2UgPyBjaGFydC5nZXRDaGFydExheW91dEludGVyZmFjZSgpIDogbnVsbDtcbiAgICBpZiAodGhpcy5tb3VzZU92ZXIub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdmVyJywgKGl0ZW06IERhdGFQb2ludFBvc2l0aW9uKSA9PiB7XG4gICAgICAgIGNvbnN0IGV2ZW50OiBDaGFydE1vdXNlT3ZlckV2ZW50ID0gdGhpcy5wYXJzZU1vdXNlRXZlbnQoaXRlbSkgYXMgQ2hhcnRNb3VzZU92ZXJFdmVudDtcbiAgICAgICAgZXZlbnQudG9vbHRpcCA9IHRoaXMuZ2V0SFRNTFRvb2x0aXAoKTtcbiAgICAgICAgdGhpcy5tb3VzZU92ZXIuZW1pdChldmVudCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKHRoaXMubW91c2VPdmVyT25lVGltZS5vYnNlcnZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZE9uZVRpbWVMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdmVyJywgKGl0ZW06IERhdGFQb2ludFBvc2l0aW9uKSA9PiB7XG4gICAgICAgIGNvbnN0IGV2ZW50OiBDaGFydE1vdXNlT3ZlckV2ZW50ID0gdGhpcy5wYXJzZU1vdXNlRXZlbnQoaXRlbSkgYXMgQ2hhcnRNb3VzZU92ZXJFdmVudDtcbiAgICAgICAgZXZlbnQudG9vbHRpcCA9IHRoaXMuZ2V0SFRNTFRvb2x0aXAoKTtcbiAgICAgICAgdGhpcy5tb3VzZU92ZXJPbmVUaW1lLmVtaXQoZXZlbnQpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubW91c2VPdXQub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdXQnLCAoaXRlbTogRGF0YVBvaW50UG9zaXRpb24pID0+IHtcbiAgICAgICAgY29uc3QgZXZlbnQ6IENoYXJ0TW91c2VPdXRFdmVudCA9IHRoaXMucGFyc2VNb3VzZUV2ZW50KGl0ZW0pIGFzIENoYXJ0TW91c2VPdXRFdmVudDtcbiAgICAgICAgdGhpcy5tb3VzZU91dC5lbWl0KGV2ZW50KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm1vdXNlT3V0T25lVGltZS5vYnNlcnZlcnMubGVuZ3RoID4gMCkge1xuICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZE9uZVRpbWVMaXN0ZW5lcihjaGFydCwgJ29ubW91c2VvdXQnLCAoaXRlbTogRGF0YVBvaW50UG9zaXRpb24pID0+IHtcbiAgICAgICAgY29uc3QgZXZlbnQ6IENoYXJ0TW91c2VPdXRFdmVudCA9IHRoaXMucGFyc2VNb3VzZUV2ZW50KGl0ZW0pIGFzIENoYXJ0TW91c2VPdXRFdmVudDtcbiAgICAgICAgdGhpcy5tb3VzZU91dE9uZVRpbWUuZW1pdChldmVudCk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5kYXRhLmNoYXJ0VHlwZSA9PT0gJ0dlb0NoYXJ0Jykge1xuICAgICAgaWYgKHRoaXMucmVnaW9uQ2xpY2sub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZExpc3RlbmVyKGNoYXJ0LCAncmVnaW9uQ2xpY2snLCAoaXRlbTogUmVnaW9uQ2xpY2tFdmVudCkgPT4ge1xuICAgICAgICAgIHRoaXMucmVnaW9uQ2xpY2suZW1pdChpdGVtKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5yZWdpb25DbGlja09uZVRpbWUub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZE9uZVRpbWVMaXN0ZW5lcihjaGFydCwgJ3JlZ2lvbkNsaWNrJywgKGl0ZW06IFJlZ2lvbkNsaWNrRXZlbnQpID0+IHtcbiAgICAgICAgICB0aGlzLnJlZ2lvbkNsaWNrLmVtaXQoaXRlbSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJDaGFydFdyYXBwZXJFdmVudHMoKTogdm9pZCB7XG4gICAgZ29vZ2xlLnZpc3VhbGl6YXRpb24uZXZlbnRzLmFkZExpc3RlbmVyKHRoaXMud3JhcHBlciwgJ3JlYWR5JywgKCkgPT4ge1xuICAgICAgdGhpcy5jaGFydFJlYWR5LmVtaXQoe21lc3NhZ2U6ICdDaGFydCByZWFkeSd9KTtcbiAgICB9KTtcblxuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRPbmVUaW1lTGlzdGVuZXIodGhpcy53cmFwcGVyLCAncmVhZHknLCAoKSA9PiB7XG4gICAgICB0aGlzLmNoYXJ0UmVhZHlPbmVUaW1lLmVtaXQoe21lc3NhZ2U6ICdDaGFydCByZWFkeSAob25lIHRpbWUpJ30pO1xuICAgICAgdGhpcy5yZWdpc3RlckNoYXJ0RXZlbnRzKCk7XG4gICAgfSk7XG5cbiAgICBnb29nbGUudmlzdWFsaXphdGlvbi5ldmVudHMuYWRkTGlzdGVuZXIodGhpcy53cmFwcGVyLCAnZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgdGhpcy5jaGFydEVycm9yLmVtaXQoZXJyb3IgYXMgQ2hhcnRFcnJvckV2ZW50KTtcbiAgICB9KTtcblxuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRPbmVUaW1lTGlzdGVuZXIodGhpcy53cmFwcGVyLCAnZXJyb3InLCAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgdGhpcy5jaGFydEVycm9yT25lVGltZS5lbWl0KGVycm9yIGFzIENoYXJ0RXJyb3JFdmVudCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmFkZExpc3RlbmVyKHRoaXMud3JhcHBlciwgJ3NlbGVjdCcsIHRoaXMuc2VsZWN0TGlzdGVuZXIsIHRoaXMuY2hhcnRTZWxlY3QpO1xuICAgIHRoaXMuYWRkT25lVGltZUxpc3RlbmVyKHRoaXMud3JhcHBlciwgJ3NlbGVjdCcsIHRoaXMuc2VsZWN0TGlzdGVuZXIsIHRoaXMuY2hhcnRTZWxlY3RPbmVUaW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkTGlzdGVuZXIoc291cmNlOiBhbnksIGV2ZW50VHlwZTogc3RyaW5nLCBsaXN0ZW5lckZuOiBhbnksIGV2RW1pdHRlcjogRXZlbnRFbWl0dGVyPGFueT4pIHtcbiAgICBnb29nbGUudmlzdWFsaXphdGlvbi5ldmVudHMuYWRkTGlzdGVuZXIoc291cmNlLCBldmVudFR5cGUsICgpID0+IHtcbiAgICAgIGV2RW1pdHRlci5lbWl0KGxpc3RlbmVyRm4oKSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFkZE9uZVRpbWVMaXN0ZW5lcihzb3VyY2U6IGFueSwgZXZlbnRUeXBlOiBzdHJpbmcsIGxpc3RlbmVyRm46IGFueSwgZXZFbWl0dGVyOiBFdmVudEVtaXR0ZXI8YW55Pikge1xuICAgIGdvb2dsZS52aXN1YWxpemF0aW9uLmV2ZW50cy5hZGRPbmVUaW1lTGlzdGVuZXIoc291cmNlLCBldmVudFR5cGUsICgpID0+IHtcbiAgICAgIGV2RW1pdHRlci5lbWl0KGxpc3RlbmVyRm4oKSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNlbGVjdExpc3RlbmVyID0gKCkgPT4ge1xuICAgIGNvbnN0IGV2ZW50OiBDaGFydFNlbGVjdEV2ZW50ID0ge1xuICAgICAgbWVzc2FnZTogJ3NlbGVjdCcsXG4gICAgICByb3c6IG51bGwsXG4gICAgICBjb2x1bW46IG51bGwsXG4gICAgICBzZWxlY3RlZFJvd1ZhbHVlczogW10sXG4gICAgICBzZWxlY3RlZFJvd0Zvcm1hdHRlZFZhbHVlczogW10sXG4gICAgICBjb2x1bW5MYWJlbDogJydcbiAgICB9O1xuICAgIGNvbnN0IHMgPSB0aGlzLndyYXBwZXIudmlzdWFsaXphdGlvbi5nZXRTZWxlY3Rpb24oKTtcbiAgICBjb25zdCBncyA9IHNbcy5sZW5ndGggLSAxXTtcbiAgICBpZiAoIWdzKSB7XG4gICAgICBldmVudC5tZXNzYWdlID0gJ2Rlc2VsZWN0JztcbiAgICAgIHJldHVybiBldmVudDtcbiAgICB9XG4gICAgY29uc3Qgc2VsZWN0aW9uOiBEYXRhUG9pbnRQb3NpdGlvbiA9IGdzO1xuICAgIGlmIChncy5yb3cgIT0gbnVsbCkge1xuICAgICAgZXZlbnQucm93ID0gc2VsZWN0aW9uLnJvdztcblxuICAgICAgY29uc3Qgc2VsZWN0ZWRSb3dWYWx1ZXMgPSBbXTtcbiAgICAgIGNvbnN0IHNlbGVjdGVkUm93Rm9ybWF0dGVkVmFsdWVzID0gW107XG4gICAgICBjb25zdCBkYXRhVGFibGUgPSB0aGlzLndyYXBwZXIuZ2V0RGF0YVRhYmxlKCk7XG4gICAgICBjb25zdCBudW1iZXJPZkNvbHVtbnMgPSBkYXRhVGFibGUuZ2V0TnVtYmVyT2ZDb2x1bW5zKCk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bWJlck9mQ29sdW1uczsgaSsrKSB7XG4gICAgICAgIHNlbGVjdGVkUm93VmFsdWVzLnB1c2goZGF0YVRhYmxlLmdldFZhbHVlKHNlbGVjdGlvbi5yb3csIGkpKTtcbiAgICAgICAgc2VsZWN0ZWRSb3dGb3JtYXR0ZWRWYWx1ZXMucHVzaChkYXRhVGFibGUuZ2V0Rm9ybWF0dGVkVmFsdWUoc2VsZWN0aW9uLnJvdywgaSkpO1xuICAgICAgfVxuICAgICAgZXZlbnQuc2VsZWN0ZWRSb3dWYWx1ZXMgPSBzZWxlY3RlZFJvd1ZhbHVlcztcbiAgICAgIGV2ZW50LnNlbGVjdGVkUm93Rm9ybWF0dGVkVmFsdWVzID0gc2VsZWN0ZWRSb3dGb3JtYXR0ZWRWYWx1ZXM7XG4gICAgfVxuICAgIGlmIChzZWxlY3Rpb24uY29sdW1uICE9IG51bGwpIHtcbiAgICAgIGV2ZW50LmNvbHVtbiA9IHNlbGVjdGlvbi5jb2x1bW47XG4gICAgICBldmVudC5jb2x1bW5MYWJlbCA9IHRoaXMuZ2V0Q29sdW1uTGFiZWxBdFBvc2l0aW9uKHNlbGVjdGlvbik7XG4gICAgfVxuICAgIGlmIChncy5uYW1lKSB7XG4gICAgICBldmVudC5jb2x1bW5MYWJlbCA9IGdzLm5hbWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGV2ZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0T3B0aW9ucygpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5vcHRpb25zID0gZ29vZ2xlLmNoYXJ0c1t0aGlzLmRhdGEuY2hhcnRUeXBlXS5jb252ZXJ0T3B0aW9ucyh0aGlzLm9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG59XG4iXX0=